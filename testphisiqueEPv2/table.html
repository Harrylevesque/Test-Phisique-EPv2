<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableaux des barèmes</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .table-container { margin-bottom: 40px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
        th { background: #f0f0f0; }
        .criteria-title { color: #007bff; font-size: 1.1em; }
    </style>
</head>
<body>
<div class="container">
    <h1>Tableaux des barèmes</h1>
    <form id="filter-form" style="display:flex;gap:10px;margin-bottom:20px;align-items:center;">
        <label>Année scolaire :
            <select id="grade-select">
                <option value="">Niveau</option>
                <option value="1">Secondaire 1</option>
                <option value="2">Secondaire 2</option>
                <option value="3">Secondaire 3</option>
                <option value="4">Secondaire 4</option>
                <option value="5">Secondaire 5</option>
            </select>
        </label>
        <label>Sexe :
            <select id="gender-select">
                <option value="">Sexe</option>
                <option value="Boy">Garçon</option>
                <option value="Girl">Fille</option>
            </select>
        </label>
        <label>Âge :
            <select id="age-select">
                <option value="">Âge</option>
            </select>
        </label>
        <button type="submit">Afficher</button>
    </form>
    <div id="tables-section"></div>
</div>
<script>
let activities = [];
const gradeSelect = document.getElementById('grade-select');
const genderSelect = document.getElementById('gender-select');
const ageSelect = document.getElementById('age-select');
const tablesSection = document.getElementById('tables-section');

// Load data
fetch('scr/fullversion.json')
    .then(r => r.json())
    .then(data => {
        activities = data;
        updateAgeOptions();
    });

gradeSelect.onchange = updateAgeOptions;
genderSelect.onchange = updateAgeOptions;

function updateAgeOptions() {
    // Set age options based on grade
    let ages = [];
    const grade = gradeSelect.value;
    if (grade === '1') ages = [12, 13];
    else if (grade === '2') ages = [13, 14];
    else if (grade === '3') ages = [14, 15];
    else if (grade === '4') ages = [15, 16];
    else if (grade === '5') ages = [16, 17];
    ageSelect.innerHTML = '<option value="">Âge</option>' + ages.map(a => `<option value="${a}">${a}</option>`).join('');
}

document.getElementById('filter-form').onsubmit = function(e) {
    e.preventDefault();
    showTables();
};

gradeSelect.onchange = function() {
    updateAgeOptions();
    showTables();
};
genderSelect.onchange = function() {
    updateAgeOptions();
    showTables();
};
ageSelect.onchange = function() {
    showTables();
};

function showTables() {
    const grade = gradeSelect.value;
    const gender = genderSelect.value;
    const age = parseInt(ageSelect.value, 10);
    if (!grade || !gender || isNaN(age)) {
        tablesSection.innerHTML = '<div style="color:red;">Veuillez sélectionner le niveau, le sexe et l\'âge.</div>';
        return;
    }
    let html = '';
    let foundAny = false;
    activities.forEach(act => {
        // Hide test léger-navette for sec 1-2
        if ((act.name === 'test léger-navette' || act.name.toLowerCase().includes('navette')) && (grade === '1' || grade === '2')) {
            return;
        }
        // Special exception for test léger-navette
        let crit;
        if (act.name === 'test léger-navette' || act.name.toLowerCase().includes('navette')) {
            let overrideAge = age;
            if (grade === '3') overrideAge = 15;
            if (grade === '4' || grade === '5') overrideAge = 17;
            crit = act.criteria.find(c => c.gender === gender && c.age === overrideAge);
        } else {
            crit = act.criteria.find(c => c.gender === gender && c.age === age);
        }
        if (!crit) return;
        foundAny = true;
        html += `<div class="table-container"><div class="criteria-title">${act.name} <span style=\"color:#888;font-size:0.95em;\">[${crit.criteria}]</span> (Max: ${crit.maxScore})</div>`;
        html += '<table><thead><tr><th>Score min</th><th>Score max</th><th>Points</th></tr></thead><tbody>';
        crit.scale.forEach(block => {
            html += `<tr><td>${block.min}</td><td>${block.max}</td><td>${block.points}</td></tr>`;
        });
        html += '</tbody></table></div>';
    });
    tablesSection.innerHTML = foundAny ? html : '<div style="color:red;">Aucune activité ne correspond à vos critères.</div>';
}
</script>
</body>
</html>
